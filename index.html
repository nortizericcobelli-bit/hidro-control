<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA HIDROPÓNICO V2 - PRECISIÓN TOTAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #050505; color: #e5e7eb; font-family: ui-sans-serif, system-ui; }
        .glass { background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(75, 85, 99, 0.2); }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
        .ph-gradient { background: linear-gradient(to right, #ef4444, #fbbf24, #22c55e, #fbbf24, #ef4444); }
        #settingsModal { display: none; }
        .modal-active { display: flex !important; }
        
        /* Estilo para los interruptores */
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #374151; transition: .3s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body class="min-h-screen p-4">

    <!-- Header con Estado de Conexión -->
    <header class="max-w-5xl mx-auto flex justify-between items-center mb-6">
        <div>
            <h1 class="text-xl font-black text-green-500 tracking-tighter uppercase">Hidro-Industrial <span class="text-white font-light">V2</span></h1>
            <div id="connStatus" class="text-[10px] font-bold text-red-500 flex items-center mt-1">
                <span class="status-dot bg-red-500 mr-2 animate-pulse"></span>DESCONECTADO
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleSettings()" class="glass p-2 rounded-xl hover:bg-gray-800 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
            <button id="btnConnect" onclick="conectarBLE()" class="bg-green-600 hover:bg-green-500 text-white text-xs px-4 py-2 rounded-xl font-bold transition-all shadow-lg active:scale-95">
                ENLAZAR
            </button>
        </div>
    </header>

    <!-- Modal Ajuste Fino -->
    <div id="settingsModal" class="fixed inset-0 z-50 items-center justify-center bg-black/90 p-4">
        <div class="glass max-w-sm w-full p-6 rounded-3xl border border-green-500/20">
            <h2 class="text-lg font-bold text-white mb-4 uppercase tracking-widest">Ajuste de Sonda</h2>
            <p class="text-[11px] text-gray-400 mb-6 italic">Si el valor del ESP32 no coincide con tu medidor manual, ajusta este desplazamiento.</p>
            
            <div class="space-y-6">
                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-[10px] font-bold text-green-400 uppercase">Compensación Digital</label>
                        <span id="offsetLabel" class="text-white font-mono font-bold">0.00</span>
                    </div>
                    <input type="range" id="phOffsetInput" min="-3" max="3" step="0.01" value="0" class="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-green-500" oninput="actualizarOffsetLabel(this.value)">
                </div>

                <div class="flex gap-3 mt-8">
                    <button onclick="toggleSettings()" class="flex-1 bg-green-600 py-3 rounded-xl font-bold text-white text-xs uppercase">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <main class="max-w-5xl mx-auto space-y-6">
        <!-- Dashboard Principal -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Tarjeta pH Gigante -->
            <div class="glass p-8 rounded-3xl border-t-4 border-green-500 relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <span class="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em]">Potencial Hidrógeno</span>
                    <span class="bg-green-500/20 text-green-400 text-[9px] px-2 py-1 rounded font-bold">ESTABLE</span>
                </div>
                
                <div class="flex items-center gap-4">
                    <span id="phVal" class="text-8xl font-black text-white tabular-nums tracking-tighter">--</span>
                    <div class="flex flex-col">
                        <span class="text-2xl font-bold text-green-500">pH</span>
                        <span id="rawPhDisplay" class="text-[10px] font-mono text-gray-600 mt-1 uppercase">RAW: --</span>
                    </div>
                </div>

                <div class="mt-8">
                    <div class="w-full h-3 bg-gray-800 rounded-full overflow-hidden ph-gradient p-[2px]">
                        <div class="bg-black h-full w-full rounded-full relative">
                            <div id="phPointer" class="absolute top-0 bottom-0 w-1 bg-white shadow-[0_0_10px_white] transition-all duration-500" style="left: 50%"></div>
                        </div>
                    </div>
                    <div class="flex justify-between mt-2 text-[9px] font-bold text-gray-600">
                        <span>ÁCIDO</span>
                        <span>NEUTRO</span>
                        <span>ALCALINO</span>
                    </div>
                </div>
            </div>

            <!-- Otros Sensores -->
            <div class="grid grid-cols-2 gap-4">
                <div class="glass p-5 rounded-2xl flex flex-col justify-center">
                    <span class="text-[9px] font-bold text-blue-400 uppercase mb-1">Nutrientes</span>
                    <div class="flex items-baseline gap-1">
                        <span id="tdsVal" class="text-3xl font-black text-white">--</span>
                        <span class="text-[10px] text-gray-500 font-bold uppercase">PPM</span>
                    </div>
                </div>
                <div class="glass p-5 rounded-2xl flex flex-col justify-center border-r-4 border-orange-500/30">
                    <span class="text-[9px] font-bold text-orange-400 uppercase mb-1">Agua</span>
                    <div class="flex items-baseline gap-1">
                        <span id="twVal" class="text-3xl font-black text-white">--</span>
                        <span class="text-[10px] text-gray-500 font-bold uppercase">°C</span>
                    </div>
                </div>
                <div class="glass p-5 rounded-2xl flex flex-col justify-center">
                    <span class="text-[9px] font-bold text-purple-400 uppercase mb-1">Humedad</span>
                    <div class="flex items-baseline gap-1">
                        <span id="haVal" class="text-3xl font-black text-white">--</span>
                        <span class="text-[10px] text-gray-500 font-bold uppercase">%</span>
                    </div>
                </div>
                <div class="glass p-5 rounded-2xl flex flex-col justify-center border-r-4 border-yellow-500/30">
                    <span class="text-[9px] font-bold text-yellow-500 uppercase mb-1">Luz</span>
                    <span id="lightVal" class="text-xs font-black text-white uppercase mt-1">--</span>
                </div>
            </div>
        </div>

        <!-- Panel de Relés -->
        <div class="glass p-6 rounded-3xl">
            <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-6 flex items-center">
                <span class="w-8 h-[1px] bg-gray-800 mr-2"></span> Control de Actuadores
            </h3>
            <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
                <script>
                    const names = ["pH Up", "pH Down", "Nutri A", "Nutri B", "Heat", "Cool", "Grow", "Humid", "Drain", "Air"];
                    names.forEach((n, i) => {
                        document.write(`
                            <div class="bg-black/40 border border-white/5 p-3 rounded-2xl flex flex-col items-center justify-between gap-3">
                                <span class="text-[8px] font-bold text-gray-500 uppercase tracking-tighter">${n}</span>
                                <label class="switch">
                                    <input type="checkbox" id="relay${i+1}" onchange="toggleRelay(${i+1}, this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        `);
                    });
                </script>
            </div>
        </div>

        <div class="flex justify-between items-center text-[8px] text-gray-700 font-bold uppercase tracking-[0.3em] px-2">
            <span id="uptime">UPTIME: --</span>
            <span>Industrial Monitoring V2.5</span>
        </div>
    </main>

    <script>
        let bleCharacteristic;
        let bleDevice;
        let phOffset = 0.00;

        function toggleSettings() {
            document.getElementById('settingsModal').classList.toggle('modal-active');
        }

        function actualizarOffsetLabel(v) {
            phOffset = parseFloat(v);
            document.getElementById('offsetLabel').innerText = (phOffset >= 0 ? "+" : "") + phOffset.toFixed(2);
        }

        async function conectarBLE() {
            try {
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'HIDRO_PRO_TOTAL' }],
                    optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
                });
                const server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
                bleCharacteristic = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');
                
                document.getElementById('connStatus').innerHTML = '<span class="status-dot bg-green-500 mr-2"></span>SISTEMA ONLINE';
                document.getElementById('connStatus').className = "text-[10px] font-bold text-green-500 flex items-center mt-1";
                document.getElementById('btnConnect').innerText = "DESCONECTAR";
                document.getElementById('btnConnect').classList.replace('bg-green-600', 'bg-red-900');

                await bleCharacteristic.startNotifications();
                bleCharacteristic.addEventListener('characteristicvaluechanged', (e) => {
                    const str = new TextDecoder().decode(e.target.value);
                    try {
                        const data = JSON.parse(str);
                        actualizarInterfaz(data);
                    } catch(err) { console.log("JSON Incompleto"); }
                });

                bleDevice.addEventListener('gattserverdisconnected', () => {
                    location.reload();
                });

            } catch (e) { console.error(e); }
        }

        async function toggleRelay(p, s) {
            if (!bleCharacteristic) return;
            const cmd = JSON.stringify({ p: p, s: s });
            await bleCharacteristic.writeValue(new TextEncoder().encode(cmd));
        }

        function actualizarInterfaz(data) {
            // Aplicar el ajuste fino sobre lo que envía el ESP32
            let rawPh = parseFloat(data.ph);
            let finalPh = rawPh + phOffset;

            document.getElementById('phVal').innerText = finalPh.toFixed(2);
            document.getElementById('rawPhDisplay').innerText = "RAW: " + rawPh.toFixed(2);
            document.getElementById('tdsVal').innerText = data.tds;
            document.getElementById('twVal').innerText = data.tw.toFixed(1);
            document.getElementById('haVal').innerText = data.ha.toFixed(1);
            document.getElementById('uptime').innerText = "UPTIME: " + data.up;
            document.getElementById('lightVal').innerText = data.light ? "ACTIVADA" : "DESACTIVADA";

            // Mover el puntero visual
            const percent = (finalPh / 14) * 100;
            document.getElementById('phPointer').style.left = Math.max(0, Math.min(100, percent)) + "%";
        }
    </script>
</body>
</html>
