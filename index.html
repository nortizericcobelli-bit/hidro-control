<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HIDROPRO V3.9 - Panel de Control</title>
    <!-- Cargamos React y Tailwind desde CDNs para que funcione en cualquier navegador -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #020617; color: #cbd5e1; font-family: sans-serif; }
        .glass-card { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(30, 41, 59, 1); }
        @keyframes pulse-custom { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-fast { animation: pulse-custom 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Componente de icono simplificado para Lucide
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const Sparkline = ({ data, color }) => {
            if (!data || data.length < 2) return null;
            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min || 1;
            const width = 120;
            const height = 40;
            const points = data.map((val, i) => {
                const x = (i / (data.length - 1)) * width;
                const y = height - ((val - min) / range) * height;
                return `${x},${y}`;
            }).join(' ');

            return (
                <svg width={width} height={height} className="overflow-visible">
                    <polyline
                        fill="none"
                        stroke={color}
                        strokeWidth="2"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        points={points}
                    />
                </svg>
            );
        };

        const App = () => {
            const apiKey = ""; // La plataforma inyectará la clave automáticamente
            const [data, setData] = useState({
                ph: 6.2, tw: 22.8, tds: 580, ta: 26.5, ha: 55, nv: 90,
                reles: Array(10).fill(0)
            });

            const [history, setHistory] = useState({
                ph: Array(20).fill(6.2),
                tds: Array(20).fill(580),
                tw: Array(20).fill(22.8),
                ta: Array(20).fill(26.5),
                ha: Array(20).fill(55)
            });

            const [aiAnalysis, setAiAnalysis] = useState("");
            const [isAnalyzing, setIsAnalyzing] = useState(false);

            useEffect(() => {
                const timer = setInterval(() => {
                    setData(prev => {
                        const newPh = Number((6.1 + Math.random() * 0.2).toFixed(2));
                        const newTds = Math.floor(570 + Math.random() * 20);
                        const newTw = Number((22.5 + Math.random() * 0.6).toFixed(1));
                        const newTa = Number((26.0 + Math.random() * 1.0).toFixed(1));
                        const newHa = Math.floor(52 + Math.random() * 6);

                        setHistory(h => ({
                            ph: [...h.ph.slice(1), newPh],
                            tds: [...h.tds.slice(1), newTds],
                            tw: [...h.tw.slice(1), newTw],
                            ta: [...h.ta.slice(1), newTa],
                            ha: [...h.ha.slice(1), newHa],
                        }));

                        const updatedReles = [
                            newPh > 6.5 ? 1 : 0, 
                            newPh < 5.5 ? 1 : 0, 
                            newTds < 500 ? 1 : 0, 
                            newTds > 800 ? 1 : 0,
                            0, 0, 1, 0, 0, 0
                        ];

                        return {
                            ...prev,
                            ph: newPh, tds: newTds, tw: newTw, ta: newTa, ha: newHa,
                            nv: Math.max(0, prev.nv - 0.01),
                            reles: updatedReles
                        };
                    });
                }, 3000);
                return () => clearInterval(timer);
            }, []);

            const analyzeWithGemini = async () => {
                setIsAnalyzing(true);
                setAiAnalysis("");
                const prompt = `Analiza: pH ${data.ph}, TDS ${data.tds}ppm, Temp ${data.tw}C. Indica estado y 1 consejo corto.`;

                let retries = 0;
                const callApi = async () => {
                    try {
                        const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        const result = await resp.json();
                        setAiAnalysis(result.candidates?.[0]?.content?.parts?.[0]?.text || "Error en respuesta.");
                    } catch (e) {
                        if (retries < 3) { retries++; setTimeout(callApi, 2000); }
                        else setAiAnalysis("No se pudo conectar con Gemini.");
                    } finally { setIsAnalyzing(false); }
                };
                callApi();
            };

            return (
                <div className="p-4 md:p-8 max-w-6xl mx-auto">
                    <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-10">
                        <div>
                            <h1 className="text-3xl font-black text-white italic tracking-tighter">
                                HIDRO<span className="text-emerald-500">PRO</span> V3.9
                            </h1>
                            <p className="text-[10px] font-mono uppercase tracking-widest text-slate-500">Monitoreo Inteligente de Cultivos</p>
                        </div>
                        <button 
                            onClick={analyzeWithGemini}
                            disabled={isAnalyzing}
                            className="mt-4 md:mt-0 flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-2xl font-bold transition-all disabled:opacity-50"
                        >
                            <Icon name="sparkles" size={16} />
                            {isAnalyzing ? "Analizando..." : "Consultar IA"}
                        </button>
                    </header>

                    {aiAnalysis && (
                        <div className="bg-indigo-900/40 border border-indigo-500/50 p-6 rounded-[2rem] mb-8 animate-pulse-slow">
                            <h3 className="text-indigo-400 text-xs font-black uppercase mb-2">Diagnóstico de Inteligencia Artificial</h3>
                            <p className="text-white italic">{aiAnalysis}</p>
                        </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {/* Tarjeta pH */}
                        <div className="glass-card p-6 rounded-[2.5rem]">
                            <div className="flex justify-between items-center mb-4 text-emerald-400">
                                <Icon name="droplet" />
                                <span className="text-[10px] font-mono opacity-50">S-01</span>
                            </div>
                            <p className="text-slate-400 text-xs">Nivel de pH</p>
                            <div className="flex items-end justify-between">
                                <h2 className="text-4xl font-black text-white">{data.ph}</h2>
                                <Sparkline data={history.ph} color="#10b981" />
                            </div>
                        </div>

                        {/* Tarjeta TDS */}
                        <div className="glass-card p-6 rounded-[2.5rem]">
                            <div className="flex justify-between items-center mb-4 text-blue-400">
                                <Icon name="zap" />
                                <span className="text-[10px] font-mono opacity-50">S-02</span>
                            </div>
                            <p className="text-slate-400 text-xs">Sólidos Disueltos (TDS)</p>
                            <div className="flex items-end justify-between">
                                <h2 className="text-4xl font-black text-white">{data.tds}<span className="text-sm font-normal opacity-50 ml-1">ppm</span></h2>
                                <Sparkline data={history.tds} color="#3b82f6" />
                            </div>
                        </div>

                        {/* Tanque */}
                        <div className="bg-indigo-600 p-6 rounded-[2.5rem] text-white">
                            <Icon name="waves" className="mb-4 opacity-50" />
                            <p className="text-xs opacity-80">Nivel de Solución</p>
                            <h2 className="text-4xl font-black mb-4">{data.nv.toFixed(1)}%</h2>
                            <div className="h-2 w-full bg-white/20 rounded-full overflow-hidden">
                                <div className="h-full bg-white transition-all duration-500" style={{width: `${data.nv}%`}}></div>
                            </div>
                        </div>
                    </div>

                    <footer className="mt-20 text-center opacity-20 text-[10px] font-mono uppercase tracking-[0.4em]">
                        Hardware HidroPro V4.1 OK - Datos en Tiempo Real
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
